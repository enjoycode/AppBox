var oe=Object.defineProperty;var re=(r,t,i)=>t in r?oe(r,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):r[t]=i;var n=(r,t,i)=>(re(r,typeof t!="symbol"?t+"":t,i),i),Q=(r,t,i)=>{if(!t.has(r))throw TypeError("Cannot "+i)};var p=(r,t,i)=>(Q(r,t,"read from private field"),i?i.call(r):t.get(r)),I=(r,t,i)=>{if(t.has(r))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(r):t.set(r,i)},C=(r,t,i,o)=>(Q(r,t,"write to private field"),o?o.call(r,i):t.set(r,i),i);import*as e from"/PixUI.js";import*as a from"/System.js";import*as m from"/AppBoxClient.js";import{Channel as le,WebChannel as se}from"/AppBoxClient.js";import*as L from"/CodeEditor.js";import{TSCSharpLanguage as ae,CodeEditorController as de,CodeEditorWidget as ce}from"/CodeEditor.js";import*as u from"/AppBoxCore.js";import{TypeSerializer as S,PayloadType as y}from"/AppBoxCore.js";const ue=function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const l of document.querySelectorAll('link[rel="modulepreload"]'))o(l);new MutationObserver(l=>{for(const s of l)if(s.type==="childList")for(const _ of s.addedNodes)_.tagName==="LINK"&&_.rel==="modulepreload"&&o(_)}).observe(document,{childList:!0,subtree:!0});function i(l){const s={};return l.integrity&&(s.integrity=l.integrity),l.referrerpolicy&&(s.referrerPolicy=l.referrerpolicy),l.crossorigin==="use-credentials"?s.credentials="include":l.crossorigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function o(l){if(l.ep)return;l.ep=!0;const s=i(l);fetch(l.href,s)}};ue();const he="modulepreload",X={},me="/",pe=function(t,i){return!i||i.length===0?t():Promise.all(i.map(o=>{if(o=`${me}${o}`,o in X)return;X[o]=!0;const l=o.endsWith(".css"),s=l?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${o}"]${s}`))return;const _=document.createElement("link");if(_.rel=l?"stylesheet":he,l||(_.as="script",_.crossOrigin=""),_.href=o,document.head.appendChild(_),l)return new Promise((ie,ne)=>{_.addEventListener("load",ie),_.addEventListener("error",()=>ne(new Error(`Unable to preload CSS for ${o}`)))})})).then(()=>t())};class Ie extends e.View{constructor(t){super();n(this,"_controller");n(this,"_version",0);t.InvalidateAction=()=>this.Run(),this._controller=t}async Run(){this._version++;const t="/preview/view/"+m.Channel.SessionId+"/"+this._controller.ModelNode.Id+"?v="+this._version;try{let i=await pe(()=>import(t),[]),o=new i[this._controller.ModelNode.Label];this.Child=new e.Container().Init({Child:o}),this.Invalidate(e.InvalidAction.Relayout)}catch(i){console.warn("\u83B7\u53D6\u9884\u89C8\u5931\u8D25: ",i)}}OnMounted(){super.OnMounted(),this.Run()}}var d=(r=>(r[r.ApplicationRoot=0]="ApplicationRoot",r[r.DataStoreRootNode=1]="DataStoreRootNode",r[r.DataStoreNode=2]="DataStoreNode",r[r.ApplicationNode=3]="ApplicationNode",r[r.ModelRootNode=4]="ModelRootNode",r[r.FolderNode=5]="FolderNode",r[r.ModelNode=6]="ModelNode",r))(d||{});class Ce{constructor(){n(this,"ModelType","");n(this,"ModelId","")}WriteTo(t){throw new a.NotSupportedException}ReadFrom(t){this.ModelType=t.ReadString(),this.ModelId=t.ReadString()}}class we{constructor(){n(this,"StartLine",0);n(this,"StartColumn",0);n(this,"EndLine",0);n(this,"EndColumn",0);n(this,"IsError",!1);n(this,"Message","")}get Position(){return`[${this.StartLine+1}, ${this.StartColumn}] - [${this.EndLine+1}, ${this.EndColumn}]`}WriteTo(t){throw new a.NotSupportedException}ReadFrom(t){this.StartLine=t.ReadInt(),this.StartColumn=t.ReadInt(),this.EndLine=t.ReadInt(),this.EndColumn=t.ReadInt(),this.IsError=t.ReadBool(),this.Message=t.ReadString()}}class ${constructor(){n(this,"Id",0);n(this,"Name","");n(this,"AllowNull",!1);n(this,"Comment")}ReadFrom(t){this.Id=t.ReadShort(),this.Name=t.ReadString(),this.AllowNull=t.ReadBool(),this.Comment=t.ReadString()}}class _e extends ${constructor(){super(...arguments);n(this,"DataType",0);n(this,"EnumModelId");n(this,"Length",0);n(this,"Decimals",0)}get Type(){return u.EntityMemberType.DataField}ReadFrom(t){super.ReadFrom(t),this.DataType=t.ReadByte(),this.DataType==u.DataFieldType.Enum&&(this.EnumModelId=t.ReadLong()),this.Length=t.ReadVariant(),this.Decimals=t.ReadVariant()}Init(t){return Object.assign(this,t),this}}class ge extends ${constructor(){super(...arguments);n(this,"IsReverse",!1);n(this,"IsAggregationRef",!1);n(this,"IsForeignKeyConstraint",!1);n(this,"RefModelIds",new a.List)}get Type(){return u.EntityMemberType.EntityRef}ReadFrom(t){super.ReadFrom(t),this.IsReverse=t.ReadBool(),this.IsAggregationRef=t.ReadBool(),this.IsForeignKeyConstraint=t.ReadBool();let i=t.ReadVariant();for(let o=0;o<i;o++)this.RefModelIds.Add(t.ReadLong())}Init(t){return Object.assign(this,t),this}}class Se extends ${constructor(){super(...arguments);n(this,"RefModelId",0n);n(this,"RefMemberId",0)}get Type(){return u.EntityMemberType.EntitySet}ReadFrom(t){super.ReadFrom(t),this.RefModelId=t.ReadLong(),this.RefMemberId=t.ReadShort()}Init(t){return Object.assign(this,t),this}}class ye{constructor(){n(this,"IsNew",!1);n(this,"Members",new a.List);n(this,"DataStoreKind",0)}WriteTo(t){throw new a.NotSupportedException}ReadFrom(t){this.IsNew=t.ReadBool(),this.DataStoreKind=t.ReadByte();let i=t.ReadVariant();for(let o=0;o<i;o++){let l=t.ReadByte(),s;switch(l){case u.EntityMemberType.DataField:s=new _e;break;case u.EntityMemberType.EntityRef:s=new ge;break;case u.EntityMemberType.EntitySet:s=new Se;break;default:throw new a.NotImplementedException}s.ReadFrom(t),this.Members.Add(s)}}Init(t){return Object.assign(this,t),this}}class Fe{static GetIconForModelType(t){switch(t){case u.ModelType.Entity:return e.Icons.Filled.TableChart;case u.ModelType.Service:return e.Icons.Filled.Settings;case u.ModelType.View:return e.Icons.Filled.Wysiwyg;case u.ModelType.Report:return e.Icons.Filled.PieChart;case u.ModelType.Enum:return e.Icons.Filled.ViewList;case u.ModelType.Permission:return e.Icons.Filled.Lock;default:return e.Icons.Filled.TableChart}}}var b,D;class F{constructor(){I(this,b,"");I(this,D,"");n(this,"Designer")}get Children(){return null}get Id(){return p(this,b)}set Id(t){C(this,b,t)}get Label(){return p(this,D)}set Label(t){C(this,D,t)}ReadFrom(t){this.Id=t.ReadString(),this.Label=t.ReadString()}}b=new WeakMap,D=new WeakMap;class Te extends F{constructor(){super(...arguments);n(this,"_children",new a.List)}get Type(){return d.DataStoreRootNode}get Children(){return this._children}ReadFrom(t){super.ReadFrom(t);let i=t.ReadVariant();for(let o=0;o<i;o++){let l=new Y;l.ReadFrom(t),this._children.Add(l)}}Init(t){return Object.assign(this,t),this}}class Y extends F{get Type(){return d.DataStoreNode}Init(t){return Object.assign(this,t),this}}class be extends F{constructor(){super(...arguments);n(this,"_children",new a.List)}get Type(){return d.ApplicationRoot}get Children(){return this._children}ReadFrom(t){super.ReadFrom(t);let i=t.ReadVariant();for(let o=0;o<i;o++){let l=new De;l.ReadFrom(t),this._children.Add(l)}}Init(t){return Object.assign(this,t),this}}class De extends F{constructor(){super(...arguments);n(this,"_children",new a.List)}get Type(){return d.ApplicationNode}get Children(){return this._children}ReadFrom(t){super.ReadFrom(t);let i=t.ReadVariant();for(let o=0;o<i;o++){let l=new Ne;l.ReadFrom(t),this._children.Add(l)}}Init(t){return Object.assign(this,t),this}}class Ne extends F{constructor(){super(...arguments);n(this,"_children",new a.List)}get Type(){return d.ModelRootNode}get Children(){return this._children}ReadFrom(t){super.ReadFrom(t);let i=t.ReadVariant();for(let o=0;o<i;o++){let l=t.ReadByte(),s;if(l==d.ModelNode)s=new z;else if(l==d.FolderNode)s=new H;else throw new a.NotSupportedException;s.ReadFrom(t),this._children.Add(s)}}Init(t){return Object.assign(this,t),this}}class H extends F{constructor(){super(...arguments);n(this,"_children",new a.List)}get Type(){return d.FolderNode}get Children(){return this._children}ReadFrom(t){super.ReadFrom(t);let i=t.ReadVariant();for(let o=0;o<i;o++){let l=t.ReadByte(),s;if(l==d.ModelNode)s=new z;else if(l==d.FolderNode)s=new H;else throw new a.NotSupportedException;s.ReadFrom(t),this._children.Add(s)}}Init(t){return Object.assign(this,t),this}}var N;class z extends F{constructor(){super(...arguments);I(this,N,0)}get Type(){return d.ModelNode}get ModelType(){return p(this,N)}set ModelType(t){C(this,N,t)}ReadFrom(t){super.ReadFrom(t),this.ModelType=t.ReadByte()}Init(t){return Object.assign(this,t),this}}N=new WeakMap;class Re{constructor(){n(this,"RootNodes",new a.List)}WriteTo(t){throw new a.NotSupportedException}ReadFrom(t){let i=t.ReadVariant();for(let o=0;o<i;o++){let l=t.ReadByte(),s;if(l==d.DataStoreRootNode)s=new Te;else if(l==d.ApplicationRoot)s=new be;else throw new a.NotSupportedException;s.ReadFrom(t),this.RootNodes.Add(s)}}Init(t){return Object.assign(this,t),this}}var R,f,M,E;class fe{constructor(){I(this,R,0);I(this,f,"");I(this,M,void 0);I(this,E,void 0)}get Kind(){return p(this,R)}set Kind(t){C(this,R,t)}get Label(){return p(this,f)}set Label(t){C(this,f,t)}get InsertText(){return p(this,M)}set InsertText(t){C(this,M,t)}get Detail(){return p(this,E)}set Detail(t){C(this,E,t)}WriteTo(t){throw new a.NotSupportedException}ReadFrom(t){this.Kind=t.ReadByte(),this.Label=t.ReadString(),this.InsertText=t.ReadString(),this.Detail=t.ReadString()}}R=new WeakMap,f=new WeakMap,M=new WeakMap,E=new WeakMap;var x,B,O,v,A;class Me{constructor(){I(this,x,0);I(this,B,"");I(this,O,void 0);I(this,v,void 0);I(this,A,0)}get ParentNodeType(){return p(this,x)}set ParentNodeType(t){C(this,x,t)}get ParentNodeId(){return p(this,B)}set ParentNodeId(t){C(this,B,t)}get NewNode(){return p(this,O)}set NewNode(t){C(this,O,t)}get RootNodeId(){return p(this,v)}set RootNodeId(t){C(this,v,t)}get InsertIndex(){return p(this,A)}set InsertIndex(t){C(this,A,t)}WriteTo(t){throw new a.NotSupportedException}ReadFrom(t){switch(this.ParentNodeType=t.ReadByte(),this.ParentNodeId=t.ReadString(),this.RootNodeId=t.ReadString(),this.InsertIndex=t.ReadInt(),t.ReadByte()){case d.FolderNode:this.NewNode=new H;break;case d.ModelNode:this.NewNode=new z;break;case d.DataStoreNode:this.NewNode=new Y;break;default:throw new a.NotSupportedException}this.NewNode.ReadFrom(t)}Init(t){return Object.assign(this,t),this}}x=new WeakMap,B=new WeakMap,O=new WeakMap,v=new WeakMap,A=new WeakMap;const J=class{get TriggerCharacters(){return[46]}async ProvideCompletionItems(t,i,o){return await m.Channel.Invoke("sys.DesignService.GetCompletion",[0,t.Tag,i,o])}Init(t){return Object.assign(this,t),this}};let P=J;n(P,"Default",new J);class V extends e.Dialog{constructor(t,i){super(t);n(this,"_name",e.State.op_Implicit_From(""));n(this,"_type");this.Width=e.State.op_Implicit_From(300),this.Height=e.State.op_Implicit_From(150),this.Title.Value=`New ${i}`,this._type=i,this.OnClose=this._OnClose.bind(this)}BuildBody(){return new e.Container().Init({Padding:e.State.op_Implicit_From(e.EdgeInsets.All(20)),Child:new e.Column(e.HorizontalAlignment.Right,20).Init({Children:[new e.Input(this._name).Init({HintText:"Please input name"}),new e.Row(e.VerticalAlignment.Middle,20).Init({Children:[new e.Button(e.State.op_Implicit_From("Cancel")).Init({OnTap:t=>this.Close(!0)}),new e.Button(e.State.op_Implicit_From("OK")).Init({OnTap:t=>this.Close(!1)})]})]})})}GetResult(t){return t?null:this._name.Value}_OnClose(t,i){if(t||a.IsNullOrEmpty(this._name.Value))return;let o=c.TreeController.FirstSelectedNode;if(o==null)return;let l=`sys.DesignService.New${this._type}`;this._type!="Application"&&this._type!="Folder"&&(l+="Model");let s=this._type=="Application"?[this._name.Value]:[o.Data.Type,o.Data.Id,this._name.Value];V.CreateAsync(l,s)}static async CreateAsync(t,i){let o=await m.Channel.Invoke(t,i);c.OnNewNode(o)}Init(t){return Object.assign(this,t),this}}class U extends e.Dialog{constructor(t){super(t);n(this,"_dataGridController",new e.DataGridController);this.Width=e.State.op_Implicit_From(400),this.Height=e.State.op_Implicit_From(300),this.Title.Value="Publish",this.OnClose=U._OnClose}BuildBody(){return new e.Container().Init({Padding:e.State.op_Implicit_From(e.EdgeInsets.All(20)),Child:new e.Column(e.HorizontalAlignment.Right,20).Init({Children:[new e.Expanded().Init({Child:new e.DataGrid(this._dataGridController).Init({Columns:new a.List().Init([new e.DataGridTextColumn("ModelType",t=>t.ModelType),new e.DataGridTextColumn("ModelId",t=>t.ModelId)])})}),new e.Row(e.VerticalAlignment.Middle,20).Init({Children:[new e.Button(e.State.op_Implicit_From("Cancel")).Init({OnTap:t=>this.Close(!0)}),new e.Button(e.State.op_Implicit_From("OK")).Init({OnTap:t=>this.Close(!1)})]})]})})}OnMounted(){super.OnMounted(),this.LoadChanges()}async LoadChanges(){try{let t=await m.Channel.Invoke("sys.DesignService.GetPendingChanges");this._dataGridController.DataSource=new a.List(t)}catch{e.Notification.Error("\u52A0\u8F7D\u6A21\u578B\u53D8\u66F4\u5931\u8D25")}}GetResult(t){return t}static async _OnClose(t,i){if(!t)try{await m.Channel.Invoke("sys.DesignService.Publish",["commit message"]),e.Notification.Success("\u53D1\u5E03\u6210\u529F")}catch{e.Notification.Error("\u53D1\u5E03\u5931\u8D25")}}Init(t){return Object.assign(this,t),this}}const T=class{static async Checkout(){let t=c.TreeController.FirstSelectedNode;if(t==null){e.Notification.Error("\u8BF7\u5148\u9009\u62E9\u5F85\u7B7E\u51FA\u8282\u70B9");return}let i=t.Data.Type;if(i!=d.ModelNode&&i!=d.ModelRootNode&&i!=d.DataStoreNode){e.Notification.Error("\u65E0\u6CD5\u7B7E\u51FA\u8BE5\u7C7B\u578B\u8282\u70B9");return}try{await m.Channel.Invoke("sys.DesignService.CheckoutNode",[Math.floor(i)&4294967295,t.Data.Id]),e.Notification.Success(`\u7B7E\u51FA\u8282\u70B9[${t.Data.Label}]\u6210\u529F`)}catch{e.Notification.Success(`\u7B7E\u51FA\u8282\u70B9[${t.Data.Label}]\u5931\u8D25`)}}static async Save(){let t=c.DesignerController.SelectedIndex;if(t<0)return;let i=c.DesignerController.GetAt(t).Designer;try{await i.SaveAsync(),e.Notification.Success("\u4FDD\u5B58\u6210\u529F")}catch{e.Notification.Error("\u4FDD\u5B58\u5931\u8D25")}}static async Delete(){let t=c.TreeController.FirstSelectedNode;if(t==null){e.Notification.Error("\u8BF7\u5148\u9009\u62E9\u5F85\u5220\u9664\u7684\u8282\u70B9");return}let i=t.Data.Type;try{let o=await m.Channel.Invoke("sys.DesignService.DeleteNode",[Math.floor(i)&4294967295,t.Data.Id]);c.OnDeleteNode(t,o),e.Notification.Success(`\u5220\u9664\u8282\u70B9[${t.Data.Label}]\u6210\u529F`)}catch{e.Notification.Success(`\u5220\u9664\u8282\u70B9[${t.Data.Label}]\u5931\u8D25`)}}};let h=T;n(h,"NewServiceCommand",()=>new V(e.UIWindow.Current.Overlay,"Service").Show()),n(h,"NewViewCommand",()=>new V(e.UIWindow.Current.Overlay,"View").Show()),n(h,"CheckoutCommand",T.Checkout),n(h,"SaveCommand",T.Save),n(h,"DeleteCommand",T.Delete),n(h,"PublishCommand",()=>new U(e.UIWindow.Current.Overlay).Show()),n(h,"NotImplCommand",()=>e.Notification.Error("\u6682\u672A\u5B9E\u73B0"));class q extends e.View{constructor(){super();n(this,"_bgColor",new e.Color(43,49,56));this.Child=new e.Container().Init({Height:e.State.op_Implicit_From(45),BgColor:e.State.op_Implicit_From(this._bgColor),Child:new e.Row().Init({Children:[new e.Container().Init({Width:e.State.op_Implicit_From(50)}),new e.Expanded().Init({Child:new e.MainMenu(q.BuildMenuItems()).Init({BackgroudColor:this._bgColor,Color:e.Colors.White})})]})})}static BuildMenuItems(){return[e.MenuItem.SubMenu("DataStore",e.Icons.Filled.Dns,[e.MenuItem.Item("Add DataStore",null,h.NotImplCommand),e.MenuItem.Item("Remove DataStore",null,h.NotImplCommand)]),e.MenuItem.SubMenu("New",e.Icons.Filled.CreateNewFolder,[e.MenuItem.Item("Application",e.Icons.Filled.Widgets,h.NotImplCommand),e.MenuItem.Item("Folder",e.Icons.Filled.Folder,h.NotImplCommand),e.MenuItem.Item("Entity",e.Icons.Filled.TableChart,h.NotImplCommand),e.MenuItem.Item("Service",e.Icons.Filled.Settings,h.NewServiceCommand),e.MenuItem.Item("View",e.Icons.Filled.Wysiwyg,h.NewViewCommand),e.MenuItem.Item("Report",e.Icons.Filled.PieChart,h.NotImplCommand),e.MenuItem.Item("Enum",e.Icons.Filled.ViewList,h.NotImplCommand),e.MenuItem.Item("Permission",e.Icons.Filled.Lock,h.NotImplCommand)]),e.MenuItem.SubMenu("Models",e.Icons.Filled.Widgets,[e.MenuItem.Item("Save",e.Icons.Filled.Save,h.SaveCommand),e.MenuItem.Item("Checkout",e.Icons.Filled.CheckCircle,h.CheckoutCommand),e.MenuItem.Item("Delete",e.Icons.Filled.DeleteForever,h.DeleteCommand),e.MenuItem.Item("Publish",e.Icons.Filled.Publish,h.PublishCommand)]),e.MenuItem.Item("Tools",e.Icons.Filled.Handyman),e.MenuItem.Item("AppStore",e.Icons.Filled.Store),e.MenuItem.Item("About",e.Icons.Filled.Help)]}Init(t){return Object.assign(this,t),this}}class Ee extends e.View{constructor(){super();this.Child=new e.Container().Init({Height:e.State.op_Implicit_From(25),BgColor:e.State.op_Implicit_From(new e.Color(4291585338)),Child:new e.Center().Init({Child:new e.Text(e.State.op_Implicit_From("enjoycode@icloud.com")).Init({TextColor:e.State.op_Implicit_From(e.Colors.White)})})})}Init(t){return Object.assign(this,t),this}}var ee=(r=>(r[r.DesignTree=0]="DesignTree",r[r.Toolbox=1]="Toolbox",r[r.Settings=2]="Settings",r))(ee||{});class xe extends e.View{constructor(){super();n(this,"_buttonColor",e.State.op_Implicit_From(e.Colors.White));n(this,"_buttonSize",e.State.op_Implicit_From(25));this.Child=new e.Container().Init({Padding:e.State.op_Implicit_From(e.EdgeInsets.Only(5,0,0,0)),Width:e.State.op_Implicit_From(45),BgColor:e.State.op_Implicit_From(new e.Color(43,49,56)),Child:new e.Column().Init({Children:[new e.Expanded().Init({Child:new e.Column(e.HorizontalAlignment.Center,5).Init({Children:[this.BuildButton(e.Icons.Filled.AccountTree,0),this.BuildButton(e.Icons.Filled.Build,1),this.BuildButton(e.Icons.Filled.Settings,2)]})}),this.BuildButton(e.Icons.Filled.ArrowLeft)]})})}BuildButton(t,i=null){let o=this._buttonColor;return i!=null&&(o=this.Compute1(c.ActiveSidePad,l=>l==i?new e.Color(4283090410):new e.Color(4285167493))),new e.Button(null,e.State.op_Implicit_From(t)).Init({FontSize:this._buttonSize,TextColor:o,Style:e.ButtonStyle.Transparent,OnTap:l=>this.OnClick(i)})}OnClick(t){t!=null&&(c.ActiveSidePad.Value=t)}Init(t){return Object.assign(this,t),this}}class Be extends e.View{constructor(){super();this.Child=new e.Row().Init({Children:[new xe,new e.Container().Init({Padding:e.State.op_Implicit_From(e.EdgeInsets.All(5)),Width:e.State.op_Implicit_From(250),BgColor:e.State.op_Implicit_From(new e.Color(4294177779)),Child:new e.Conditional(c.ActiveSidePad,[new e.WhenBuilder(t=>t==0,()=>new K),new e.WhenBuilder(t=>t==1,()=>new Oe),new e.WhenBuilder(t=>t==2,()=>new ve)])})]})}Init(t){return Object.assign(this,t),this}}class K extends e.View{constructor(){super();n(this,"_searchKey",e.State.op_Implicit_From(""));n(this,"_hasLoadTree",!1);this.Child=new e.Column().Init({Children:[new e.Input(this._searchKey).Init({Prefix:new e.Icon(e.State.op_Implicit_From(e.Icons.Filled.Search))}),new e.TreeView(c.TreeController)]})}static BuildTreeNode(t,i){i.Icon=new e.Icon(e.State.op_Implicit_From(K.GetIconForNode(t))),i.Label=new e.Text(e.State.op_Implicit_From(t.Label)),i.IsLeaf=t.Type==d.ModelNode||t.Type==d.DataStoreNode,i.IsExpanded=t.Type==d.DataStoreRootNode||t.Type==d.ApplicationRoot}static GetIconForNode(t){switch(t.Type){case d.DataStoreNode:return e.Icons.Filled.Storage;case d.ApplicationNode:return e.Icons.Filled.Widgets;case d.ModelNode:return Fe.GetIconForModelType(t.ModelType);default:return e.Icons.Filled.Folder}}OnMounted(){super.OnMounted(),this.LoadDesignTree()}async LoadDesignTree(){if(this._hasLoadTree)return;this._hasLoadTree=!0;let t=await m.Channel.Invoke("sys.DesignService.LoadDesignTree");c.TreeController.DataSource=t.RootNodes}Init(t){return Object.assign(this,t),this}}class Oe extends e.View{constructor(){super();this.Child=new e.Text(e.State.op_Implicit_From("Toolbox"))}Init(t){return Object.assign(this,t),this}}class ve extends e.View{constructor(){super();this.Child=new e.Text(e.State.op_Implicit_From("Settings"))}Init(t){return Object.assign(this,t),this}}class W extends e.View{constructor(){super();n(this,"_tabController");this._tabController=new e.TabController(new a.List().Init(["Problems","Usages","Output"])),this.Child=new e.Container().Init({Height:e.State.op_Implicit_From(190),Child:new e.TabView(this._tabController,W.BuildTab,W.BuildBody,!1,40).Init({SelectedTabColor:e.Colors.White,TabBarBgColor:new e.Color(4294177779)})})}static BuildTab(t,i){let o=e.RxComputed.Make1(i,l=>l?e.Theme.FocusedColor:e.Colors.Black);return new e.Text(e.State.op_Implicit_From(t)).Init({TextColor:o})}static BuildBody(t){return t=="Problems"?new e.DataGrid(c.ProblemsController).Init({Columns:new a.List().Init([new e.DataGridTextColumn("Position",i=>i.Position,e.ColumnWidth.Fixed(180)),new e.DataGridTextColumn("Message",i=>i.Message)])}):new e.Container().Init({Padding:e.State.op_Implicit_From(e.EdgeInsets.All(10)),BgColor:e.State.op_Implicit_From(e.Colors.White),Child:new e.Text(e.State.op_Implicit_From(t))})}Init(t){return Object.assign(this,t),this}}class k extends e.View{constructor(){super();c.TreeController.SelectionChanged.Add(this.OnTreeSelectionChanged,this),c.DesignerController.TabClosed.Add(this.OnDesignerClosed,this),this.BgColor=e.State.op_Implicit_From(e.Colors.White),this.Child=new e.TabView(c.DesignerController,k.BuildTab,k.BuildBody,!0,40).Init({SelectedTabColor:e.Colors.White,TabBarBgColor:new e.Color(4294177779)})}static BuildTab(t,i){let o=e.RxComputed.Make1(i,l=>l?e.Theme.FocusedColor:e.Colors.Black);return new e.Text(e.State.op_Implicit_From(t.Label)).Init({TextColor:o})}static BuildBody(t){if(t.Type==d.ModelNode){let i=t;switch(i.ModelType){case u.ModelType.Entity:{let o=new We(i);return t.Designer=o,o}case u.ModelType.View:{let o=new G(i);return t.Designer=o,o}case u.ModelType.Service:{let o=new j(i);return t.Designer=o,o}}}return new e.Container().Init({Padding:e.State.op_Implicit_From(e.EdgeInsets.All(10)),BgColor:e.State.op_Implicit_From(e.Colors.White),Child:new e.Text(e.State.op_Implicit_From(t.Label))})}async OnDesignerClosed(t){if(t.Type==d.ModelNode){let i=t;(i.ModelType==u.ModelType.Service||i.ModelType==u.ModelType.View)&&await m.Channel.Invoke("sys.DesignService.CloseDesigner",[Math.floor(t.Type)&4294967295,t.Id])}}OnTreeSelectionChanged(){let t=c.TreeController.FirstSelectedNode;if(t!=null&&t.Data instanceof z){let i=c.DesignerController.IndexOf(t.Data);i<0?c.DesignerController.Add(t.Data):c.DesignerController.SelectAt(i)}}Init(t){return Object.assign(this,t),this}}const w=class{static get ProblemsController(){return w._problemsController??(w._problemsController=new e.DataGridController),w._problemsController}static OnNewNode(t){let i=w.TreeController.FindNode(l=>l.Type==t.ParentNodeType&&l.Id==t.ParentNodeId),o=w.TreeController.InsertNode(t.NewNode,i,t.InsertIndex);w.TreeController.ExpandTo(o),w.TreeController.SelectNode(o)}static OnDeleteNode(t,i){w.DesignerController.Remove(t.Data),w.TreeController.RemoveNode(t)}static UpdateProblems(t,i){w.ProblemsController.DataSource=i}};let c=w;n(c,"ActiveSidePad",e.State.op_Implicit_From(ee.DesignTree)),n(c,"TreeController",new e.TreeController(K.BuildTreeNode,t=>t.Children)),n(c,"DesignerController",new e.TabController(new a.List)),n(c,"_problemsController");class Ae{static async TryInit(){if(S.GetSerializer(y.DesignTree)!=null)return;const t=window.TreeSitter;await t.init();let i=await t.Language.load("/tree-sitter-c_sharp.wasm");ae.Init(i),S.RegisterKnownType(y.EntityModelVO,!1,()=>new ye),S.RegisterKnownType(y.DesignTree,!1,()=>new Re),S.RegisterKnownType(y.NewNodeResult,!1,()=>new Me),S.RegisterKnownType(y.CodeProblem,!0,()=>new we),S.RegisterKnownType(y.CompletionItem,!0,()=>new fe),S.RegisterKnownType(y.ChangedModel,!0,()=>new Ce)}}class te{constructor(t,i){n(this,"_targetType");n(this,"_targetId");n(this,"_submittingFlag",0);n(this,"_queue",new a.List);this._targetType=t,this._targetId=i}OnDocumentChanged(t){this._queue.Add(new Le(t.Offset,t.Length,t.Text)),this.StartSubmit()}async StartSubmit(){if(this._submittingFlag==0){for(this._submittingFlag=1;this._queue.length>0;){let t=this._queue[0];await m.Channel.Invoke("sys.DesignService.ChangeBuffer",[this._targetType,this._targetId,t.Offset,t.Length,t.Text]),this._queue.RemoveAt(0)}this._submittingFlag=0}}}class Le{constructor(t,i,o){n(this,"Offset");n(this,"Length");n(this,"Text");this.Offset=t,this.Length=i,this.Text=o}}class Pe extends e.RxObject{constructor(){super();n(this,"Name");n(this,"DataType");n(this,"Comment");this.Name=new e.RxProperty(()=>this.Object.Name),this.DataType=new e.RxProperty(()=>this.Object.DataType),this.Comment=new e.RxProperty(()=>this.Object.Comment??"",t=>this.Object.Comment=t)}Init(t){return Object.assign(this,t),this}}class Ve extends e.View{constructor(t,i){super();n(this,"_labelWidth",120);n(this,"_entityModel");n(this,"_selectedMember");n(this,"_rxEntityField",new Pe);this._entityModel=t,this._selectedMember=this.Bind(i,e.BindingOptions.None);let o=this._selectedMember.AsStateOfBool(l=>l!=null&&l.Type==u.EntityMemberType.DataField);this.Child=new e.Column(e.HorizontalAlignment.Left).Init({Children:[new e.Text(e.State.op_Implicit_From("Entity Properties:")).Init({FontWeight:e.State.op_Implicit_From(CanvasKit.FontWeight.Bold)}),new e.Form().Init({LabelWidth:this._labelWidth,Children:[new e.FormItem("DataStoreKind:",new e.Input(e.State.op_Implicit_From("SqlStore")).Init({Readonly:e.State.op_Implicit_From(!0)})),new e.FormItem("DataStoreName:",new e.Input(e.State.op_Implicit_From("Default")).Init({Readonly:e.State.op_Implicit_From(!0)})),new e.FormItem("Comment:",new e.Input(e.State.op_Implicit_From("")))]}),new e.IfConditional(o,()=>new e.Text(e.State.op_Implicit_From("EntityField Properties:")).Init({FontWeight:e.State.op_Implicit_From(CanvasKit.FontWeight.Bold)})),new e.IfConditional(o,()=>new e.Form().Init({LabelWidth:this._labelWidth,Children:[new e.FormItem("Name:",new e.Input(this._rxEntityField.Name).Init({Readonly:e.State.op_Implicit_From(!0)})),new e.FormItem("DataType:",new e.Input(this._rxEntityField.DataType.AsStateOfString(l=>u.DataFieldType[l])).Init({Readonly:e.State.op_Implicit_From(!0)})),new e.FormItem("Comment:",new e.Input(this._rxEntityField.Comment))]}))]})}OnStateChanged(t,i){if(t===this._selectedMember){this._selectedMember.Value!=null&&this._selectedMember.Value.Type==u.EntityMemberType.DataField&&(this._rxEntityField.Object=this._selectedMember.Value);return}super.OnStateChanged(t,i)}Init(t){return Object.assign(this,t),this}}class Z extends e.View{constructor(t,i){super();n(this,"_membersController");n(this,"_selectedMember",new e.Rx(null));this._membersController=i,this._membersController.SelectionChanged.Add(this.OnSelectedMemberChanged,this),this.Child=new e.Row().Init({Children:[new e.Expanded().Init({Child:new e.DataGrid(i).Init({Columns:new a.List().Init([new e.DataGridTextColumn("Name",o=>o.Name,e.ColumnWidth.Fixed(150)),new e.DataGridTextColumn("Type",Z.MemberTypeToString,e.ColumnWidth.Fixed(200)),new e.DataGridTextColumn("AllowNull",o=>o.AllowNull.toString(),e.ColumnWidth.Fixed(90)),new e.DataGridTextColumn("Comment",o=>o.Comment??"")])})}),new e.Container().Init({BgColor:e.State.op_Implicit_From(new e.Color(4294177779)),Width:e.State.op_Implicit_From(280),Child:new Ve(t,this._selectedMember)})]})}OnSelectedMemberChanged(){this._selectedMember.Value=this._membersController.SelectedRows.length==0?null:this._membersController.SelectedRows[0]}static MemberTypeToString(t){return t.Type==u.EntityMemberType.DataField?`${u.EntityMemberType[t.Type]} - ${u.DataFieldType[t.DataType]}`:u.EntityMemberType[t.Type]}Init(t){return Object.assign(this,t),this}}class We extends e.View{constructor(t){super();n(this,"_modelNode");n(this,"_activePad",e.State.op_Implicit_From(0));n(this,"_hasLoad",!1);n(this,"_loaded",e.State.op_Implicit_From(!1));n(this,"_entityModel");n(this,"_membersController",new e.DataGridController);this._modelNode=t,this.Child=new e.Column().Init({Children:[this.BuildActionBar(),new e.Expanded().Init({Child:new e.IfConditional(this._loaded,()=>new e.Conditional(this._activePad,[new e.WhenBuilder(i=>i==0,()=>new Z(this._entityModel,this._membersController))]),null)})]})}BuildActionBar(){return new e.Container().Init({BgColor:e.State.op_Implicit_From(e.Colors.White),Height:e.State.op_Implicit_From(40),Padding:e.State.op_Implicit_From(e.EdgeInsets.Only(15,8,15,8)),Child:new e.Row(e.VerticalAlignment.Middle,10).Init({Children:[new e.Button(e.State.op_Implicit_From("Members")).Init({Width:e.State.op_Implicit_From(75)}),new e.Button(e.State.op_Implicit_From("Options")).Init({Width:e.State.op_Implicit_From(75)}),new e.Button(e.State.op_Implicit_From("Data")).Init({Width:e.State.op_Implicit_From(75)})]})})}OnMounted(){super.OnMounted(),this.TryLoadEntityModel()}async TryLoadEntityModel(){if(!this._hasLoad){this._hasLoad=!0;try{this._entityModel=await m.Channel.Invoke("sys.DesignService.OpenEntityModel",[this._modelNode.Id]),this._membersController.DataSource=this._entityModel.Members,this._loaded.Value=!0}catch{e.Notification.Error("\u65E0\u6CD5\u52A0\u8F7D\u5B9E\u4F53\u6A21\u578B")}}}SaveAsync(){throw new a.NotImplementedException}Init(t){return Object.assign(this,t),this}}class j extends e.View{constructor(t){super();n(this,"_modelNode");n(this,"_codeEditorController");n(this,"_codeSyncService");n(this,"_delayDocChangedTask");n(this,"_hasLoadSourceCode",!1);this._modelNode=t,this._codeEditorController=new L.CodeEditorController(`${t.Label}.cs`,"",P.Default,t.Id),this._codeSyncService=new te(0,t.Id),this._delayDocChangedTask=new e.DelayTask(300,this.RunDelayTask.bind(this)),this.Child=j.BuildEditor(this._codeEditorController)}static BuildEditor(t){return new e.Column().Init({Children:[j.BuildActionBar(),new e.Expanded().Init({Child:new L.CodeEditorWidget(t)})]})}static BuildActionBar(){return new e.Container().Init({BgColor:e.State.op_Implicit_From(new e.Color(4282137660)),Height:e.State.op_Implicit_From(40),Padding:e.State.op_Implicit_From(e.EdgeInsets.Only(15,8,15,8)),Child:new e.Row(e.VerticalAlignment.Middle,10).Init({Children:[new e.Button(e.State.op_Implicit_From("Run")).Init({Width:e.State.op_Implicit_From(75)}),new e.Button(e.State.op_Implicit_From("Debug")).Init({Width:e.State.op_Implicit_From(75)})]})})}OnMounted(){super.OnMounted(),this.TryLoadSourceCode()}async TryLoadSourceCode(){if(this._hasLoadSourceCode)return;this._hasLoadSourceCode=!0;let t=await m.Channel.Invoke("sys.DesignService.OpenServiceModel",[this._modelNode.Id]);this._codeEditorController.Document.TextContent=t,this._codeEditorController.Document.DocumentChanged.Add(this.OnDocumentChanged,this)}OnDocumentChanged(t){this._codeSyncService.OnDocumentChanged(t),this._delayDocChangedTask.Run()}async RunDelayTask(){let t=await m.Channel.Invoke("sys.DesignService.GetProblems",[!1,this._modelNode.Id]);c.UpdateProblems(this._modelNode,t)}Dispose(){super.Dispose(),this._hasLoadSourceCode&&this._codeEditorController.Document.DocumentChanged.Remove(this.OnDocumentChanged,this)}async SaveAsync(){await m.Channel.Invoke("sys.DesignService.SaveModel",[this._modelNode.Id])}Init(t){return Object.assign(this,t),this}}class ke{constructor(t){n(this,"ModelNode");n(this,"_invalidateAction");this.ModelNode=t}set InvalidateAction(t){this._invalidateAction=t}Invalidate(){this._invalidateAction?.call(this)}}class je extends e.View{constructor(t){super();n(this,"_scale",e.Matrix4.CreateIdentity());this.Child=new e.Container().Init({BgColor:e.State.op_Implicit_From(new e.Color(4288848546)),Padding:e.State.op_Implicit_From(e.EdgeInsets.All(10)),Child:new e.Card().Init({Elevation:e.State.op_Implicit_From(10),Child:new e.Transform(this._scale.Clone()).Init({Child:new Ie(t)})})})}Init(t){return Object.assign(this,t),this}}class G extends e.View{constructor(t){super();n(this,"_modelNode");n(this,"_codeEditorController");n(this,"_codeSyncService");n(this,"_previewController");n(this,"_delayDocChangedTask");n(this,"_hasLoadSourceCode",!1);this._modelNode=t,this._previewController=new ke(t),this._codeEditorController=new L.CodeEditorController(`${t.Label}.cs`,"",P.Default,t.Id),this._codeSyncService=new te(0,t.Id),this._delayDocChangedTask=new e.DelayTask(300,this.RunDelayTask.bind(this)),this.Child=new e.Row().Init({Children:[new e.Expanded(G.BuildEditor(this._codeEditorController),2),new e.Expanded(new je(this._previewController),1)]})}static BuildEditor(t){return new e.Column().Init({Children:[G.BuildActionBar(),new e.Expanded().Init({Child:new L.CodeEditorWidget(t)})]})}static BuildActionBar(){return new e.Container().Init({BgColor:e.State.op_Implicit_From(new e.Color(4282137660)),Height:e.State.op_Implicit_From(40),Padding:e.State.op_Implicit_From(e.EdgeInsets.Only(15,8,15,8)),Child:new e.Row(e.VerticalAlignment.Middle,10).Init({Children:[new e.Button(e.State.op_Implicit_From("Preview")).Init({Width:e.State.op_Implicit_From(75)}),new e.Button(e.State.op_Implicit_From("Debug")).Init({Width:e.State.op_Implicit_From(75)})]})})}OnMounted(){super.OnMounted(),this.TryLoadSourceCode()}async TryLoadSourceCode(){if(this._hasLoadSourceCode)return;this._hasLoadSourceCode=!0;let t=await m.Channel.Invoke("sys.DesignService.OpenViewModel",[this._modelNode.Id]);this._codeEditorController.Document.TextContent=t,this._codeEditorController.Document.DocumentChanged.Add(this.OnDocumentChanged,this)}OnDocumentChanged(t){this._codeSyncService.OnDocumentChanged(t),this._delayDocChangedTask.Run()}async RunDelayTask(){let t=await m.Channel.Invoke("sys.DesignService.GetProblems",[!1,this._modelNode.Id]);c.UpdateProblems(this._modelNode,t),t.Any(i=>i.IsError)||this._previewController.Invalidate()}Dispose(){super.Dispose(),this._hasLoadSourceCode&&this._codeEditorController.Document.DocumentChanged.Remove(this.OnDocumentChanged,this)}async SaveAsync(){await m.Channel.Invoke("sys.DesignService.SaveModel",[this._modelNode.Id])}Init(t){return Object.assign(this,t),this}}class Ge extends e.View{constructor(){super();n(this,"_userName",e.State.op_Implicit_From(""));n(this,"_password",e.State.op_Implicit_From(""));n(this,"_inputSize",e.State.op_Implicit_From(20));this.Child=new e.Center().Init({Child:new e.Card().Init({Width:e.State.op_Implicit_From(400),Height:e.State.op_Implicit_From(330),Elevation:e.State.op_Implicit_From(20),Child:this.BuildLoginForm()})})}BuildLoginForm(){return new e.Container().Init({Padding:e.State.op_Implicit_From(e.EdgeInsets.All(30)),Child:new e.Column(e.HorizontalAlignment.Center,30).Init({Children:[new e.Text(e.State.op_Implicit_From("Welcome")).Init({FontSize:e.State.op_Implicit_From(50)}),new e.Input(this._userName).Init({HintText:"Account",FontSize:this._inputSize,Prefix:new e.Icon(e.State.op_Implicit_From(e.Icons.Filled.Person)).Init({Size:this._inputSize})}),new e.Input(this._password).Init({IsObscure:!0,HintText:"Password",FontSize:this._inputSize,Prefix:new e.Icon(e.State.op_Implicit_From(e.Icons.Filled.Lock)).Init({Size:this._inputSize})}),new e.Button(e.State.op_Implicit_From("Login")).Init({OnTap:t=>this.OnLogin()})]})})}async OnLogin(){await Ae.TryInit(),await m.Channel.Login(this._userName.Value,this._password.Value),this.CurrentNavigator.PushNamed("IDE")}Init(t){return Object.assign(this,t),this}}class He extends e.View{constructor(){super();this.Child=new e.Column().Init({Children:[new q,new e.Expanded().Init({Child:new e.Row().Init({Children:[new Be,new e.Expanded().Init({Child:new e.Column().Init({Children:[new e.Expanded().Init({Child:new k}),new W]})})]})}),new Ee]})}Init(t){return Object.assign(this,t),this}}class ze extends e.View{constructor(){super();let t=new e.Navigator(new a.List().Init([new e.Route("Login",i=>new Ge),new e.Route("IDE",i=>new He)]));this.Child=new e.RouteView(t)}Init(t){return Object.assign(this,t),this}}class g{constructor(t,i,o=null){n(this,"Icon");n(this,"Text");n(this,"Children");this.Icon=t,this.Text=i,this.Children=o}}class Ke{static Make1(){let t=e.Colors.Red.obs,i=30 .obs;return new e.Column().Init({Children:[new e.Button("Button".obs).Init({OnTap:o=>{t.Value=e.Colors.Random(),i.Value=clamp(Math.random()*100,18,100)}}),new e.Text("Hello\u4E2D\u56FD".obs).Init({TextColor:t,FontSize:i}),new e.Input("Hello".obs).Init({Width:180 .obs})]})}static Make2(){let t=new e.AnimationController(200),i=new e.CurvedAnimation(t,e.Curves.EaseInOutCubic),o=new e.FloatTween(.75,1).Animate(i),l=new e.ExpandIcon(o);return l.OnPointerDown=s=>{t.Value==0?t.Forward():t.Reverse()},l}static DemoTransform(){let t=e.Matrix4.CreateIdentity();return t.Translate(25,25),t.RotateZ(20*(Math.PI/180)),new e.Container().Init({Width:300 .obs,Height:300 .obs,BgColor:e.Colors.Green.obs,Child:new e.Transform(t,new e.Offset(50,50)).Init({Child:new e.Container().Init({Width:100 .obs,Height:100 .obs,BgColor:e.Colors.Red.obs})})})}static DemoTreeView(){let t=new a.List([new g(e.Icons.Filled.Cloud,"Cloud",new a.List([new g(e.Icons.Filled.Train,"Train"),new g(e.Icons.Filled.AirplanemodeOn,"AirPlane")])),new g(e.Icons.Filled.BeachAccess,"Beach",new a.List([new g(e.Icons.Filled.Cake,"Cake",new a.List([new g(e.Icons.Filled.Apple,"Apple"),new g(e.Icons.Filled.Adobe,"Adobe")])),new g(e.Icons.Filled.Camera,"Camera")])),new g(e.Icons.Filled.Sunny,"Sunny")]),i=new e.TreeController((o,l)=>{l.Icon=new e.Icon(e.State.op_Implicit_From(o.Icon)),l.Label=new e.Text(o.Text.obs),l.IsLeaf=o.Children==null},o=>o.Children);return i.DataSource=t,new e.Container().Init({Padding:e.State.op_Implicit_From(e.EdgeInsets.All(20)),Child:new e.TreeView(i).Init({Color:new e.Color(4292664540).obs})})}static MakeCodeEditor(){const t=`
public sealed class Person
{
    public string Name { get; set; }

    public void SayHello()
    {
        System.Console.WriteLine(Name);
    }
} //\u4E2D\u56FD */
`;let i=new de("Demo.cs",t);return new e.Container().Init({Padding:new e.Rx(e.EdgeInsets.All(20)),Child:new ce(i)})}static MakeDev(){return new ze}}le.Init(new se);e.WebApplication.Init();e.WebApplication.Run(Ke.MakeDev);
